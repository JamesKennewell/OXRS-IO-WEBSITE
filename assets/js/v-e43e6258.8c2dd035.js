"use strict";(self.webpackChunkoxrs_docs_site=self.webpackChunkoxrs_docs_site||[]).push([[597],{3794:(e,n,s)=>{s.r(n),s.d(n,{data:()=>a});const a={key:"v-e43e6258",path:"/docs/firmware/state-controller-esp32.html",title:"State Controller ESP32",lang:"en-US",frontmatter:{tags:["OXRS-SHA-RACK32","RACK32"]},excerpt:"",headers:[{level:2,title:"Introduction",slug:"introduction",children:[{level:3,title:"How does it work?",slug:"how-does-it-work",children:[]},{level:3,title:"Interlocking",slug:"interlocking",children:[]},{level:3,title:"Timers",slug:"timers",children:[]}]},{level:2,title:"Configuration",slug:"configuration",children:[{level:3,title:"Outputs",slug:"outputs",children:[]}]},{level:2,title:"Commands",slug:"commands",children:[{level:3,title:"Examples",slug:"examples-1",children:[]}]},{level:2,title:"Events",slug:"events",children:[{level:3,title:"Examples",slug:"examples-2",children:[]}]},{level:2,title:"Supported Hardware",slug:"supported-hardware",children:[]}],filePathRelative:"docs/firmware/state-controller-esp32.md",git:{updatedTime:1631407916e3,contributors:[{name:"Jonathan Oxer",email:"jon@oxer.com.au",commits:1}]}}},5876:(e,n,s)=>{s.r(n),s.d(n,{default:()=>F});var a=s(6252);const o=(0,a.uE)('<h1 id="state-controller-esp32" tabindex="-1"><a class="header-anchor" href="#state-controller-esp32" aria-hidden="true">#</a> State Controller ESP32</h1><p class="maker">by <b>Ben Jones</b></p><blockquote><p>SKU: OXRS-SHA-STATECONTROLLER-ESP32-FW</p></blockquote><h2 id="introduction" tabindex="-1"><a class="header-anchor" href="#introduction" aria-hidden="true">#</a> Introduction</h2><p>A binary state controller for DIY home automation projects.</p><p>Listens for MQTT messages and send on/off binary output signals using MCP23017 I2C I/O buffers.</p><p>Typically the output signals would be used to drive relay coils in order to switch larger voltages - e.g. light circuits.</p><hr><h3 id="how-does-it-work" tabindex="-1"><a class="header-anchor" href="#how-does-it-work" aria-hidden="true">#</a> How does it work?</h3><p>Outputs can be switched by publishing an MQTT message to the configured MQTT broker.</p><p>Each output can be configured as a <code>relay</code>, for simple <code>on</code>/<code>off</code> control. A <code>motor</code>, again with <code>on</code>/<code>off</code> control but longer interlock delays if interlocking is configured. Or a <code>timer</code>, for <code>on</code> and then timed <code>off</code> control.</p>',11),t=(0,a.Uk)("The firmware is designed to run on hardware using MCP23017 I/O buffer chips via I2C, e.g. the "),r={href:"https://bmdesigns.com.au/shop/relay16-16-channel-relay-driver/",target:"_blank",rel:"noopener noreferrer"},p=(0,a.Uk)("16 Channel Relay Driver"),l=(0,a.Uk)("."),i=(0,a.uE)('<p>A single I2C bus can only support up to a maximum of 8x MCP23017 chips (addresses <code>0x20-0x27</code>). Therefore the maximum number of supported outputs is 128 (i.e. 8x MCP23017s * 16x I/O pins).</p><h3 id="interlocking" tabindex="-1"><a class="header-anchor" href="#interlocking" aria-hidden="true">#</a> Interlocking</h3><p>Interlocking two outputs allows them to control equipment such as roller blinds, garage doors, louvre roofing etc.</p><p>However if you are planning to control a motor of any sort then it is important that the two outputs are configured as type <code>motor</code> and that both are interlocked with each other. This is to ensure that both outputs will not be commanded to operate at the same time and adds a 2 second delay between any changes of output.</p><p>Example payload to confingure outputs 4 &amp; 5 to control a set of roller blinds;</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">[</span>\n  <span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;motor&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;lock&quot;</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token punctuation">{</span> <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;motor&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;lock&quot;</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span>\n<span class="token punctuation">]</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The operation of the interlocked outputs should be verified before connecting to any external equipment. External interlocking equipment may be required for some equipment. Most importantly, the manufacturers wiring and installation guides must be adhered to.</p><h3 id="timers" tabindex="-1"><a class="header-anchor" href="#timers" aria-hidden="true">#</a> Timers</h3><p>Timers allow an output to automatically turn <code>off</code> a set number of seconds after being turned <code>on</code> (configurable via <code>timerSeconds</code>, which defaults to 60 seconds).</p><p>If another <code>on</code> command is sent while the timer is running, it will reset to zero and being counting down again. If an <code>off</code> command is sent the timer will be cancelled and the output turned <code>off</code> immediately.</p><h2 id="configuration" tabindex="-1"><a class="header-anchor" href="#configuration" aria-hidden="true">#</a> Configuration</h2><h3 id="outputs" tabindex="-1"><a class="header-anchor" href="#outputs" aria-hidden="true">#</a> Outputs</h3><p>Each OUTPUT can be configured by publishing an MQTT message to this topic;</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[PREFIX/]conf/CLIENTID[/SUFFIX]\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>where:</p><ul><li><code>PREFIX</code>: Optional topic prefix if required</li><li><code>CLIENTID</code>: Client id of device, defaults to <code>osc-&lt;MACADDRESS&gt;</code></li><li><code>SUFFIX</code>: Optional topic suffix if required</li></ul><p>The message payload should be JSON and contain:</p><ul><li><code>index</code>: Mandatory, the index of the output to configure</li><li><code>type</code>: Optional, either <code>motor</code>, <code>relay</code>, or <code>timer</code></li><li><code>interlockIndex</code>: Optional, index to interlock with (lock the opposite for interlocking both ways)</li><li><code>timerSeconds</code>: Number of seconds an output stays <code>on</code> when type set to <code>timer</code></li></ul><p>A null or empty value will reset the configuration to:</p><ul><li><code>type</code>: <code>relay</code></li><li><code>interlockIndex</code>: unlocked (i.e. self-interlocked)</li><li><code>timerSeconds</code>: 60 seconds</li></ul><h4 id="examples" tabindex="-1"><a class="header-anchor" href="#examples" aria-hidden="true">#</a> Examples</h4><p>To configure output 4 to be a 60 second timer:</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span> \n  <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> \n  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;timer&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;timerSeconds&quot;</span><span class="token operator">:</span> <span class="token number">60</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>To configure output 7 to drive a motor:</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span> \n  <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> \n  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;motor&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>A retained message will ensure the device auto-configures on startup.</p><p>The only difference between <code>motor</code> and <code>relay</code> outputs is the interlock delay (if an interlock is configured).</p><table><thead><tr><th>Output Type</th><th>Interlock delay</th></tr></thead><tbody><tr><td><code>motor</code></td><td>2000ms</td></tr><tr><td><code>relay</code></td><td>500ms</td></tr></tbody></table><h2 id="commands" tabindex="-1"><a class="header-anchor" href="#commands" aria-hidden="true">#</a> Commands</h2><p>Each OUTPUT can be controlled by publishing an MQTT message to the topic;</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[PREFIX/]cmnd/CLIENTID[/SUFFIX]\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>where;</p><ul><li><code>PREFIX</code>: Optional topic prefix if required</li><li><code>CLIENTID</code>: Client id of device, defaults to <code>osc-&lt;MACADDRESS&gt;</code></li><li><code>SUFFIX</code>: Optional topic suffix if required</li></ul><p>The message payload should be JSON and contain:</p><ul><li><code>index</code>: Mandatory, the index of the output to configure</li><li><code>command</code>: Either <code>on</code>, <code>off</code>, or <code>query</code></li></ul><p>The <code>query</code> command will cause an event to be published, with the current state of that output.</p><h3 id="examples-1" tabindex="-1"><a class="header-anchor" href="#examples-1" aria-hidden="true">#</a> Examples</h3><p>To turn on output 4:</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span> \n  <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> \n  <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token string">&quot;on&quot;</span> \n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>To query the state of output 7:</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span> \n  <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> \n  <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token string">&quot;query&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="events" tabindex="-1"><a class="header-anchor" href="#events" aria-hidden="true">#</a> Events</h2><p>An output STATE CHANGE is reported to a topic of the form;</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>[PREFIX/]stat/CLIENTID[/SUFFIX]\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>where;</p><ul><li><code>PREFIX</code>: Optional topic prefix if required</li><li><code>CLIENTID</code>: Client id of device, defaults to <code>osc-&lt;MACADDRESS&gt;</code></li><li><code>SUFFIX</code>: Optional topic suffix if required</li></ul><p>The message payload is JSON and contains:</p><ul><li><code>index</code>: The index of this event (1-128)</li><li><code>type</code>: Either <code>motor</code>, <code>relay</code>, or <code>timer</code></li><li><code>event</code>: Either <code>on</code> or <code>off</code></li></ul><h3 id="examples-2" tabindex="-1"><a class="header-anchor" href="#examples-2" aria-hidden="true">#</a> Examples</h3><p>A relay turning on for output 6;</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> \n  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;relay&quot;</span><span class="token punctuation">,</span> \n  <span class="token property">&quot;event&quot;</span><span class="token operator">:</span> <span class="token string">&quot;on&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>A timer turning off for output 12;</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;index&quot;</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> \n  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;timer&quot;</span><span class="token punctuation">,</span> \n  <span class="token property">&quot;event&quot;</span><span class="token operator">:</span> <span class="token string">&quot;off&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="supported-hardware" tabindex="-1"><a class="header-anchor" href="#supported-hardware" aria-hidden="true">#</a> Supported Hardware</h2><p>This firmware is compatible with the boards;</p>',55),c={href:"https://www.superhouse.tv/product/8-channel-relay-driver-shield/",target:"_blank",rel:"noopener noreferrer"},d=(0,a.Uk)("8 Channel Relay Driver Shield"),u=(0,a.Uk)(" by SuperHouse"),h={href:"https://bmdesigns.com.au/shop/relay128-128-channel-relay-driver/",target:"_blank",rel:"noopener noreferrer"},m=(0,a.Uk)("128 Channel Relay Driver"),b=(0,a.Uk)(" by Bedrock Media Designs"),k={href:"https://bmdesigns.com.au/shop/relay16-16-channel-relay-driver/",target:"_blank",rel:"noopener noreferrer"},f=(0,a.Uk)("16 Channel Relay Driver"),g=(0,a.Uk)(" by Bedrock Media Designs"),y=(0,a.Uk)("And is designed to run on the "),x=(0,a.Uk)("RACK32"),v=(0,a.Uk)(" as part of the "),q={href:"https://oxrs.io",target:"_blank",rel:"noopener noreferrer"},w=(0,a.Uk)("OXRS"),T=(0,a.Uk)(" eco-system."),I=(0,a._)("h4",{id:"credits",tabindex:"-1"},[(0,a._)("a",{class:"header-anchor",href:"#credits","aria-hidden":"true"},"#"),(0,a.Uk)(" Credits")],-1),S=(0,a._)("li",null,[(0,a.Uk)("Jonathan Oxer "),(0,a._)("a",{href:"mailto:jon@oxer.com.au"},"jon@oxer.com.au")],-1),E=(0,a.Uk)("Ben Jones "),C={href:"https://github.com/sumnerboy12",target:"_blank",rel:"noopener noreferrer"},_=(0,a.Uk)("https://github.com/sumnerboy12"),U=(0,a.Uk)("Moin "),O={href:"https://github.com/moinmoin-sh",target:"_blank",rel:"noopener noreferrer"},j=(0,a.Uk)("https://github.com/moinmoin-sh"),A=(0,a._)("h4",{id:"license",tabindex:"-1"},[(0,a._)("a",{class:"header-anchor",href:"#license","aria-hidden":"true"},"#"),(0,a.Uk)(" License")],-1),R=(0,a._)("p",null,[(0,a.Uk)("Copyright 2020-2021 SuperHouse Automation Pty Ltd "),(0,a._)("a",{href:"www.superhouse.tv"},"www.superhouse.tv")],-1),D=(0,a._)("p",null,'The software portion of this project is licensed under the Simplified BSD License. The "licence" folder within this project contains a copy of this license in plain text format.',-1),F={render:function(e,n){const s=(0,a.up)("OutboundLink"),F=(0,a.up)("RouterLink");return(0,a.wg)(),(0,a.iD)(a.HY,null,[o,(0,a._)("p",null,[t,(0,a._)("a",r,[p,(0,a.Wm)(s)]),l]),i,(0,a._)("ul",null,[(0,a._)("li",null,[(0,a._)("a",c,[d,(0,a.Wm)(s)]),u]),(0,a._)("li",null,[(0,a._)("a",h,[m,(0,a.Wm)(s)]),b]),(0,a._)("li",null,[(0,a._)("a",k,[f,(0,a.Wm)(s)]),g])]),(0,a._)("p",null,[y,(0,a.Wm)(F,{to:"/docs/hardware/controllers/rack32.html"},{default:(0,a.w5)((()=>[x])),_:1}),v,(0,a._)("a",q,[w,(0,a.Wm)(s)]),T]),I,(0,a._)("ul",null,[S,(0,a._)("li",null,[E,(0,a._)("a",C,[_,(0,a.Wm)(s)])]),(0,a._)("li",null,[U,(0,a._)("a",O,[j,(0,a.Wm)(s)])])]),A,R,D],64)}}}}]);